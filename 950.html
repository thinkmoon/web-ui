<!DOCTYPE html>
<html  data-head-attrs="">

<head >
  <title>使用github Action自动部署博客 | 指尖魔法屋-醉月思的博客</title><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><script async src="/ads.js" crossorigin="anonymous"></script><meta name="keywords" content="thinkmoon,指尖魔法屋,醉月思的博客"><meta name="description" content="web前端开发工程师、面向高保真编程、总结与记录是两个极其优秀的学习习惯、对知识和技术保持敬畏之心！"><meta name="head:count" content="5"><link rel="modulepreload" href="/nuxt-asset/entry-4033bfcf.mjs" as="script" crossorigin><link rel="preload" href="/nuxt-asset/entry.7e762317.css" as="style"><link rel="modulepreload" href="/nuxt-asset/default-ab4b1d95.mjs" as="script" crossorigin><link rel="preload" href="/nuxt-asset/default.8dc03fb7.css" as="style"><link rel="modulepreload" href="/nuxt-asset/Footer-39451558.mjs" as="script" crossorigin><link rel="modulepreload" href="/nuxt-asset/_cid_-40efc3b3.mjs" as="script" crossorigin><link rel="modulepreload" href="/nuxt-asset/asyncData-b0244fb3.mjs" as="script" crossorigin><link rel="prefetch" href="/nuxt-asset/background.36a7be78.jpg"><link rel="prefetch" as="script" href="/nuxt-asset/404-0c215052.mjs"><link rel="prefetch" as="script" href="/nuxt-asset/editor-3321b87d.mjs"><link rel="prefetch" as="script" href="/nuxt-asset/index-b882dfe7.mjs"><link rel="prefetch" as="script" href="/nuxt-asset/post-list-93b150a9.mjs"><link rel="prefetch" as="script" href="/nuxt-asset/admin-f89c7533.mjs"><link rel="prefetch" as="script" href="/nuxt-asset/_pageIndex_-08429fca.mjs"><link rel="prefetch" as="script" href="/nuxt-asset/PostList-693c3f84.mjs"><link rel="prefetch" as="script" href="/nuxt-asset/index-dbca3f00.mjs"><link rel="prefetch" as="script" href="/nuxt-asset/index-dc59a107.mjs"><link rel="prefetch" as="script" href="/nuxt-asset/login-d8f7e58b.mjs"><link rel="prefetch" as="script" href="/nuxt-asset/_pageIndex_-4617af3f.mjs"><link rel="prefetch" as="script" href="/nuxt-asset/_pageIndex_-38aaa266.mjs"><link rel="prefetch" as="script" href="/nuxt-asset/TagApi-b908df3a.mjs"><link rel="prefetch" as="script" href="/nuxt-asset/index-12cec95d.mjs"><link rel="prefetch" as="script" href="/nuxt-asset/auth-f948a8cb.mjs"><link rel="prefetch" as="script" href="/nuxt-asset/admin-1ee1b85d.mjs"><link rel="stylesheet" href="/nuxt-asset/entry.7e762317.css"><link rel="stylesheet" href="/nuxt-asset/default.8dc03fb7.css">
</head>

<body  data-head-attrs="">
  <div id="__nuxt"><!--[--><div><div class="top-menu" data-v-2d323d18><ul role="menubar" style="--el-menu-text-color:;--el-menu-hover-text-color:;--el-menu-bg-color:;--el-menu-hover-bg-color:;--el-menu-active-color:;" class="el-menu el-menu--horizontal" data-v-2d323d18><li class="el-menu-item" role="menuitem" tabindex="-1" style="" data-v-2d323d18><!--[--><!--[--> 指尖魔法屋 <!--]--><!--[--><!--]--><!--]--></li><li class="el-menu-item" role="menuitem" tabindex="-1" style="" data-v-2d323d18><!--[--><!--[--><a href="/category" class="" data-v-2d323d18> 分类 </a><!--]--><!--[--><!--]--><!--]--></li><li class="el-menu-item" role="menuitem" tabindex="-1" style="" data-v-2d323d18><!--[--><!--[--><a href="/tag" class="" data-v-2d323d18> 标签 </a><!--]--><!--[--><!--]--><!--]--></li></ul><div class="right" data-v-2d323d18><a class="el-link el-link--default" href="/login" data-v-2d323d18><!--v-if--><span class="el-link__inner"><!--[--><i class="el-icon pointer" style="font-size:26px;" data-v-2d323d18><!--[--><svg viewbox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" data-v-2d323d18><path fill="currentColor" d="M512 512a192 192 0 1 0 0-384 192 192 0 0 0 0 384zm0 64a256 256 0 1 1 0-512 256 256 0 0 1 0 512zm320 320v-96a96 96 0 0 0-96-96H288a96 96 0 0 0-96 96v96a32 32 0 1 1-64 0v-96a160 160 0 0 1 160-160h448a160 160 0 0 1 160 160v96a32 32 0 1 1-64 0z"></path></svg><!--]--></i><!--]--></span><!--v-if--></a></div></div><div class="app-container"><!--[--><div class="app-container" data-v-14f20b86><!----><div class="article-content" data-v-14f20b86><div class="v-md-editor-preview" style="tab-size:2;" data-v-14f20b86><div class="github-markdown-body"><h1 data-v-md-heading="使用github-action自动部署博客" data-v-md-line="1">使用github Action自动部署博客</h1>
<h2 data-v-md-heading="背景提要" data-v-md-line="2">背景提要</h2>
<p data-v-md-line="4">为什么需要它？最开始我使用的是本地编译，然后手动上传的方式，后来发现过于麻烦。尤其是nuxt编译后，产生一大堆ouput文件，手动上传耗时费力。</p>
<p data-v-md-line="6">再后来我在服务器上，设置了一个定时任务。每晚从github拉取最新的代码，然后在服务器上编译。实行了一段时间，感觉还行。但是，随着服务上的服务越来越多，资源占有越来越大，我发现偶尔会出现编译nuxt时内存溢出的情况（请原谅我1核2G的服务，它已经尽力了）。</p>
<p data-v-md-line="8">然后便产生了，使用githu action编译目标产物ouput文件，通知服务器自动拉取的想法。那么，说干就干，试试吧！</p>
<h2 data-v-md-heading="创建github-action" data-v-md-line="10">创建GitHub Action</h2>
<p data-v-md-line="12">使用node.js模板，该模板会自动使用预装node.js的环境。模板中有三种node.js版本，如果保持预留配置，则会三个环境都执行一次。这里我只使用16.x版本（因为跟我服务器版本一致）</p>
<p data-v-md-line="14"><img src="https://blog.cdn.thinkmoon.cn/2022-04-10/23-08-15" alt="创建GitHub Action"></p>
<p data-v-md-line="16">大致流程可分为</p>
<ol data-v-md-line="17">
<li>拉取代码</li>
<li>安装依赖</li>
<li>编译output</li>
<li>归档到特定分支（gh-pages）</li>
<li>web-hook通知服务器</li>
<li>服务接收事件，拉取编译后的文件，并重启</li>
</ol>
<h2 data-v-md-heading="拉取代码" data-v-md-line="24">拉取代码</h2>
<p data-v-md-line="25">该步骤由github完成，只需声明使用的分支名称即可</p>
<h2 data-v-md-heading="安装依赖" data-v-md-line="27">安装依赖</h2>
<p data-v-md-line="29"><img src="https://blog.cdn.thinkmoon.cn/2022-04-10/23-15-32" alt="GitHub Action 安装依赖"></p>
<h2 data-v-md-heading="编译output" data-v-md-line="31">编译output</h2>
<div data-v-md-line="32"><div class="v-md-pre-wrapper v-md-pre-wrapper-yaml extra-class"><pre class="v-md-hljs-yaml"><code> <span class="hljs-bullet">-</span> <span class="hljs-attr">run:</span> <span class="hljs-string">yarn</span> <span class="hljs-string">run</span> <span class="hljs-string">build</span>
</code></pre>
</div></div><h2 data-v-md-heading="归档到特定分支-gh-page" data-v-md-line="35">归档到特定分支（gh-page）</h2>
<p data-v-md-line="37">我这儿随便在maket place选一个开源Action（GitHub Pages v3），配置对应的参数，如下：</p>
<div data-v-md-line="39"><div class="v-md-pre-wrapper v-md-pre-wrapper-yaml extra-class"><pre class="v-md-hljs-yaml"><code><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">GitHub</span> <span class="hljs-string">Pages</span> <span class="hljs-string">v3</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">peaceiris/actions-github-pages@v3.1.12</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">personal_token:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.ACCESS_TOKEN</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">publish_dir:</span> <span class="hljs-string">.output</span>
</code></pre>
</div></div><blockquote data-v-md-line="47">
<p data-v-md-line="47">请注意：关于这个personal_token，github有个坑。我也是折腾了两个多小时才总结出来的。生成的personal_token是不能明文存储在yaml文件中的，必须使用变量传递。否则一旦提交的时候，github出于安全考虑会自动静默删除对应person_token。</p>
</blockquote>
<h2 data-v-md-heading="完整配置" data-v-md-line="49">完整配置</h2>
<div data-v-md-line="51"><div class="v-md-pre-wrapper v-md-pre-wrapper-yaml extra-class"><pre class="v-md-hljs-yaml"><code><span class="hljs-comment"># This workflow will do a clean installation of node dependencies, cache/restore them, build the source code and run tests across different versions of node</span>
<span class="hljs-comment"># For more information see: https://help.github.com/actions/language-and-framework-guides/using-nodejs-with-github-actions</span>

<span class="hljs-attr">name:</span> <span class="hljs-string">Node.js</span> <span class="hljs-string">CI</span>

<span class="hljs-attr">on:</span>
  <span class="hljs-attr">push:</span>
    <span class="hljs-attr">branches:</span> [ <span class="hljs-string">main</span> ]
  <span class="hljs-attr">pull_request:</span>
    <span class="hljs-attr">branches:</span> [ <span class="hljs-string">main</span> ]

<span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">build:</span>
   <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>

   <span class="hljs-attr">strategy:</span>
      <span class="hljs-attr">matrix:</span>
        <span class="hljs-attr">node-version:</span> [<span class="hljs-number">16.</span><span class="hljs-string">x</span>]
        <span class="hljs-comment"># See supported Node.js release schedule at https://nodejs.org/en/about/releases/</span>

   <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v3</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Use</span> <span class="hljs-string">Node.js</span> <span class="hljs-string">${{</span> <span class="hljs-string">matrix.node-version</span> <span class="hljs-string">}}</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/setup-node@v3</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">run:</span> <span class="hljs-string">yarn</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">run:</span> <span class="hljs-string">yarn</span> <span class="hljs-string">run</span> <span class="hljs-string">build</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">GitHub</span> <span class="hljs-string">Pages</span> <span class="hljs-string">v3</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">peaceiris/actions-github-pages@v3.1.12</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">personal_token:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.ACCESS_TOKEN</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">publish_dir:</span> <span class="hljs-string">.output</span>
</code></pre>
</div></div><h2 data-v-md-heading="触发action" data-v-md-line="85">触发Action</h2>
<p data-v-md-line="87">提交代码，等待流水线执行。</p>
<p data-v-md-line="89"><img src="https://blog.cdn.thinkmoon.cn/2022-04-11/23-45-08" alt="Github Action执行效果"></p>
<h2 data-v-md-heading="webhook推送归档成功事件" data-v-md-line="91">webhook推送归档成功事件</h2>
<p data-v-md-line="93">绑定对应的webhook，监听gh-pages部署事件。</p>
<p data-v-md-line="95"><img src="https://blog.cdn.thinkmoon.cn/2022-04-11/23-48-31" alt="webhook推送归档成功事件"></p>
<h2 data-v-md-heading="服务器拉取代码并执行重启" data-v-md-line="97">服务器拉取代码并执行重启</h2>
<blockquote data-v-md-line="99">
<p data-v-md-line="99">这里为了方便起见，我使用的是宝塔面板的webhook插件</p>
</blockquote>
<p data-v-md-line="101"><img src="https://blog.cdn.thinkmoon.cn/2022-04-11/23-50-12" alt="宝塔面板的webhook插件"></p>
<p data-v-md-line="103">执行的脚本如下</p>
<div data-v-md-line="105"><div class="v-md-pre-wrapper v-md-pre-wrapper-bash extra-class"><pre class="v-md-hljs-bash"><code>PATH=/www/wwwroot/nuxtBlog/node_modules/.bin:/www/server/nodejs/v16.14.2/bin:/bin:/sbin:/usr/bin:/usr/sbin:/usr/<span class="hljs-built_in">local</span>/bin:/usr/<span class="hljs-built_in">local</span>/sbin:~/bin
<span class="hljs-built_in">export</span> PATH

<span class="hljs-built_in">export</span> NODE_PROJECT_NAME=<span class="hljs-string">&quot;nuxtBlog&quot;</span>
<span class="hljs-built_in">cd</span> /www/wwwroot/nuxtBlog/.output
git pull
<span class="hljs-built_in">cd</span> ..
<span class="hljs-built_in">kill</span> -9 $(lsof -i:3000 |awk <span class="hljs-string">&#x27;{print $2}&#x27;</span> | tail -n 1)
nohup /www/server/nodejs/v16.14.2/bin/npm run start 2&gt;&amp;1 &gt;&gt; /www/server/nodejs/vhost/logs/nuxtBlog.log &amp;
<span class="hljs-built_in">echo</span> $! &gt; /www/server/nodejs/vhost/pids/nuxtBlog.pid
<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;启动成功&quot;</span>
</code></pre>
</div></div><h2 data-v-md-heading="各步骤成功截图" data-v-md-line="119">各步骤成功截图</h2>
<blockquote data-v-md-line="121">
<p data-v-md-line="121">Action执行效果</p>
</blockquote>
<p data-v-md-line="123"><img src="https://blog.cdn.thinkmoon.cn/2022-04-11/23-51-51" alt="Action执行效果"></p>
<blockquote data-v-md-line="125">
<p data-v-md-line="125">webhook通知记录</p>
</blockquote>
<p data-v-md-line="127"><img src="https://blog.cdn.thinkmoon.cn/2022-04-11/23-52-54" alt="webhook通知记录"></p>
<blockquote data-v-md-line="129">
<p data-v-md-line="129">宝塔面板执行日志</p>
</blockquote>
<p data-v-md-line="131"><img src="https://blog.cdn.thinkmoon.cn/2022-04-11/23-53-45" alt="宝塔面板执行日志"></p>
<p data-v-md-line="133">搞定收工！大功告成。</p>
<blockquote data-v-md-line="135">
<p data-v-md-line="135">版权声明: 本文首发于<a href="https://www.thinkmoon.cn/post/950" class="custom-internal-link" target="_blank">指尖魔法屋-使用github Action自动部署博客</a>,转载或引用必须申明原指尖魔法屋来源及源地址！</p>
</blockquote>
</div></div></div></div><!--]--></div><span></span></div><div class="footer" data-v-68ae0dac><span data-v-68ae0dac>Copyright © 2017-2022 指尖魔法屋. All rights reserved</span><span data-v-68ae0dac>POWERED BY thinkBlog · v0.1.5 · build-20220508-0235</span><span data-v-68ae0dac>网站持续搭建中，感谢关注</span><span data-v-68ae0dac>本站已顽强运行：蛮久了~</span><div data-v-68ae0dac><a class="el-link el-link--primary is-underline" href="http://beian.miit.gov.cn/" data-v-68ae0dac><!--v-if--><span class="el-link__inner"><!--[--> 粤ICP备17055617号 <!--]--></span><!--v-if--></a></div></div><!--]--></div><script>window.__NUXT__=(function(a){return {data:{pinia:{},article:{cid:950,title:"使用github Action自动部署博客",created:1649601754,modified:1650444879,text:"## 背景提要\n\n为什么需要它？最开始我使用的是本地编译，然后手动上传的方式，后来发现过于麻烦。尤其是nuxt编译后，产生一大堆ouput文件，手动上传耗时费力。\n\n再后来我在服务器上，设置了一个定时任务。每晚从github拉取最新的代码，然后在服务器上编译。实行了一段时间，感觉还行。但是，随着服务上的服务越来越多，资源占有越来越大，我发现偶尔会出现编译nuxt时内存溢出的情况（请原谅我1核2G的服务，它已经尽力了）。\n\n然后便产生了，使用githu action编译目标产物ouput文件，通知服务器自动拉取的想法。那么，说干就干，试试吧！\n\n## 创建GitHub Action\n\n使用node.js模板，该模板会自动使用预装node.js的环境。模板中有三种node.js版本，如果保持预留配置，则会三个环境都执行一次。这里我只使用16.x版本（因为跟我服务器版本一致）\n\n![创建GitHub Action](https:\u002F\u002Fblog.cdn.thinkmoon.cn\u002F2022-04-10\u002F23-08-15)\n\n大致流程可分为\n1. 拉取代码\n2. 安装依赖\n3. 编译output\n4. 归档到特定分支（gh-pages）\n5. web-hook通知服务器\n6. 服务接收事件，拉取编译后的文件，并重启\n\n## 拉取代码\n该步骤由github完成，只需声明使用的分支名称即可\n\n## 安装依赖\n\n![GitHub Action 安装依赖](https:\u002F\u002Fblog.cdn.thinkmoon.cn\u002F2022-04-10\u002F23-15-32)\n\n## 编译output\n```yaml\n - run: yarn run build\n```\n## 归档到特定分支（gh-page）\n\n我这儿随便在maket place选一个开源Action（GitHub Pages v3），配置对应的参数，如下：\n\n```yaml\n- name: GitHub Pages v3\n        uses: peaceiris\u002Factions-github-pages@v3.1.12\n        with:\n          personal_token: ${{ secrets.ACCESS_TOKEN }}\n          publish_dir: .output\n```\n\n\u003E 请注意：关于这个personal_token，github有个坑。我也是折腾了两个多小时才总结出来的。生成的personal_token是不能明文存储在yaml文件中的，必须使用变量传递。否则一旦提交的时候，github出于安全考虑会自动静默删除对应person_token。\n\n## 完整配置\n\n```yaml\n# This workflow will do a clean installation of node dependencies, cache\u002Frestore them, build the source code and run tests across different versions of node\n# For more information see: https:\u002F\u002Fhelp.github.com\u002Factions\u002Flanguage-and-framework-guides\u002Fusing-nodejs-with-github-actions\n\nname: Node.js CI\n\non:\n  push:\n    branches: [ main ]\n  pull_request:\n    branches: [ main ]\n\njobs:\n  build:\n   runs-on: ubuntu-latest\n\n   strategy:\n      matrix:\n        node-version: [16.x]\n        # See supported Node.js release schedule at https:\u002F\u002Fnodejs.org\u002Fen\u002Fabout\u002Freleases\u002F\n\n   steps:\n      - uses: actions\u002Fcheckout@v3\n      - name: Use Node.js ${{ matrix.node-version }}\n        uses: actions\u002Fsetup-node@v3\n      - run: yarn\n      - run: yarn run build\n\n      - name: GitHub Pages v3\n        uses: peaceiris\u002Factions-github-pages@v3.1.12\n        with:\n          personal_token: ${{ secrets.ACCESS_TOKEN }}\n          publish_dir: .output\n```\n## 触发Action\n\n提交代码，等待流水线执行。\n\n![Github Action执行效果](https:\u002F\u002Fblog.cdn.thinkmoon.cn\u002F2022-04-11\u002F23-45-08)\n\n## webhook推送归档成功事件\n\n绑定对应的webhook，监听gh-pages部署事件。\n\n![webhook推送归档成功事件](https:\u002F\u002Fblog.cdn.thinkmoon.cn\u002F2022-04-11\u002F23-48-31)\n\n## 服务器拉取代码并执行重启\n\n\u003E 这里为了方便起见，我使用的是宝塔面板的webhook插件\n\n![宝塔面板的webhook插件](https:\u002F\u002Fblog.cdn.thinkmoon.cn\u002F2022-04-11\u002F23-50-12)\n\n执行的脚本如下\n\n```bash\nPATH=\u002Fwww\u002Fwwwroot\u002FnuxtBlog\u002Fnode_modules\u002F.bin:\u002Fwww\u002Fserver\u002Fnodejs\u002Fv16.14.2\u002Fbin:\u002Fbin:\u002Fsbin:\u002Fusr\u002Fbin:\u002Fusr\u002Fsbin:\u002Fusr\u002Flocal\u002Fbin:\u002Fusr\u002Flocal\u002Fsbin:~\u002Fbin\nexport PATH\n\nexport NODE_PROJECT_NAME=\"nuxtBlog\"\ncd \u002Fwww\u002Fwwwroot\u002FnuxtBlog\u002F.output\ngit pull\ncd ..\nkill -9 $(lsof -i:3000 |awk '{print $2}' | tail -n 1)\nnohup \u002Fwww\u002Fserver\u002Fnodejs\u002Fv16.14.2\u002Fbin\u002Fnpm run start 2\u003E&1 \u003E\u003E \u002Fwww\u002Fserver\u002Fnodejs\u002Fvhost\u002Flogs\u002FnuxtBlog.log &\necho $! \u003E \u002Fwww\u002Fserver\u002Fnodejs\u002Fvhost\u002Fpids\u002FnuxtBlog.pid\necho \"启动成功\"\n```\n\n## 各步骤成功截图\n\n\u003E Action执行效果\n\n![Action执行效果](https:\u002F\u002Fblog.cdn.thinkmoon.cn\u002F2022-04-11\u002F23-51-51)\n\n\u003E webhook通知记录\n\n![webhook通知记录](https:\u002F\u002Fblog.cdn.thinkmoon.cn\u002F2022-04-11\u002F23-52-54)\n\n\u003E 宝塔面板执行日志\n\n![宝塔面板执行日志](https:\u002F\u002Fblog.cdn.thinkmoon.cn\u002F2022-04-11\u002F23-53-45)\n\n搞定收工！大功告成。\n",authorId:a,comments:a,views:a,likes:a,tag:[],category:"闲余折腾",category_id:13,fields:{}}},state:{error:null},_errors:{},serverRendered:true,config:{public:{TITLE:"指尖魔法屋-醉月思的博客",VERSION:"0.1.5 · build-20220508-0235",KEYWORDS:["thinkmoon","指尖魔法屋","醉月思的博客"],DESCRIPTION:"web前端开发工程师、面向高保真编程、总结与记录是两个极其优秀的学习习惯、对知识和技术保持敬畏之心！",baseUrl:"https:\u002F\u002Fservice.thinkmoon.cn\u002Fapi"},app:{baseURL:"\u002F",buildAssetsDir:"\u002Fnuxt-asset\u002F",cdnURL:""}}}}(0))</script><script type="module" src="/nuxt-asset/entry-4033bfcf.mjs" crossorigin></script><script type="module" src="/nuxt-asset/default-ab4b1d95.mjs" crossorigin></script><script type="module" src="/nuxt-asset/_cid_-40efc3b3.mjs" crossorigin></script>
</body>

</html>